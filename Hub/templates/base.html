{% load static %}<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>{% block title %}VibeMall{% endblock %}</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/preloader.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/meanmenu.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/owl-carousel.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/swiper-bundle.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/backtotop.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/magnific-popup.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/nice-select.css' %}">
    <link rel="stylesheet" href="{% static 'assets/flaticon/flaticon.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/font-awesome-pro.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/default.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/custom-fixes.css' %}">
</head>
<body>
    {% include 'header.html' %}
    <main>
        {% block content %}{% endblock %}
    </main>
        {% include 'footer.html' %}
        
        <div id="supportChatWidget">
            <button id="supportChatToggle" type="button">Support</button>
            <div id="supportChatPanel" class="chat-hidden">
                <div class="chat-header">
                    <span>Support</span>
                    <button id="supportChatClose" type="button">x</button>
                </div>
                <div id="supportChatMessages" class="chat-messages"></div>
                {% if not user.is_authenticated %}
                <div id="supportChatGuest" class="chat-guest chat-hidden">
                    <input type="text" id="supportGuestName" placeholder="Your name">
                    <input type="email" id="supportGuestEmail" placeholder="Your email">
                </div>
                {% endif %}
                <div class="chat-quick-replies">
                    <button type="button" class="chat-quick" data-text="Size guide">Size guide</button>
                    <button type="button" class="chat-quick" data-text="Return policy">Return policy</button>
                    <button type="button" class="chat-quick" data-text="Shipping">Shipping</button>
                </div>
                <div class="chat-input">
                    <label for="supportChatFiles" class="chat-attach">Attach</label>
                    <input type="file" id="supportChatFiles" class="chat-file-input" multiple accept="image/*,video/mp4,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    <input type="text" id="supportChatInput" placeholder="Type your message...">
                    <button id="supportChatSend" type="button">Send</button>
                </div>
            </div>
        </div>

        <!-- JavaScript Variables -->
        <script>
            var userAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
            {% if user.is_authenticated %}var wishlistProductIds = {{ wishlist_product_ids|safe }};{% endif %}
        </script>
        
        <script src="{% static 'assets/js/vendor/jquery.js' %}"></script>    
        <script src="{% static 'assets/js/vendor/waypoints.js' %}"></script>
        <script src="{% static 'assets/js/bootstrap-bundle.js' %}"></script>
        <script src="{% static 'assets/js/meanmenu.js' %}"></script>
        <script src="{% static 'assets/js/swiper-bundle.js' %}"></script>
        <script src="{% static 'assets/js/tweenmax.js' %}"></script>
        <script src="{% static 'assets/js/owl-carousel.js' %}"></script>
        <script src="{% static 'assets/js/magnific-popup.js' %}"></script>
        <script src="{% static 'assets/js/parallax.js' %}"></script>
        <script src="{% static 'assets/js/backtotop.js' %}"></script>
        <script src="{% static 'assets/js/nice-select.js' %}"></script>
        <script src="{% static 'assets/js/countdown.min.js' %}"></script>
        <script src="{% static 'assets/js/counterup.js' %}"></script>
        <script src="{% static 'assets/js/wow.js' %}"></script>
        <script src="{% static 'assets/js/isotope-pkgd.js' %}"></script>
        <script src="{% static 'assets/js/imagesloaded-pkgd.js' %}"></script>
        <script src="{% static 'assets/js/ajax-form.js' %}"></script>
        <script src="{% static 'assets/js/main.js' %}"></script>
        <script src="{% static 'assets/js/custom-fixes.js' %}"></script>
        
            <style>
                #supportChatWidget {
                    position: fixed;
                    right: 24px;
                    bottom: 24px;
                    z-index: 9999;
                    font-family: Arial, sans-serif;
                }
                #supportChatToggle {
                    background: #0f172a;
                    color: #fff;
                    border: none;
                    border-radius: 999px;
                    padding: 12px 18px;
                    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2);
                    cursor: pointer;
                }
                #supportChatPanel {
                    width: 320px;
                    background: #ffffff;
                    border: 1px solid #e5e7eb;
                    border-radius: 16px;
                    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.15);
                    margin-top: 12px;
                    overflow: hidden;
                }
                .chat-hidden {
                    display: none;
                }
                .chat-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: #0f172a;
                    color: #fff;
                }
                #supportChatClose {
                    background: transparent;
                    border: none;
                    color: #fff;
                    font-size: 16px;
                    cursor: pointer;
                }
                .chat-messages {
                    height: 240px;
                    overflow-y: auto;
                    padding: 12px 16px;
                    background: #f8fafc;
                }
                .chat-bubble {
                    padding: 8px 10px;
                    border-radius: 10px;
                    margin-bottom: 8px;
                    font-size: 13px;
                }
                .chat-bubble.user {
                    background: #ffffff;
                    border: 1px solid #e2e8f0;
                    max-width: 80%;
                }
                .chat-bubble.admin {
                    background: #e0f2fe;
                    border: 1px solid #bae6fd;
                    max-width: 80%;
                    margin-left: auto;
                }
                .chat-guest {
                    padding: 0 16px 10px;
                    display: grid;
                    gap: 8px;
                }
                .chat-guest input {
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 8px;
                    font-size: 13px;
                }
                .chat-quick-replies {
                    padding: 0 16px 10px;
                    display: flex;
                    gap: 6px;
                    flex-wrap: wrap;
                }
                .chat-quick {
                    background: #e2e8f0;
                    border: none;
                    border-radius: 999px;
                    padding: 6px 10px;
                    font-size: 12px;
                    cursor: pointer;
                }
                .chat-input {
                    display: flex;
                    gap: 6px;
                    padding: 12px 16px 16px;
                    align-items: center;
                }
                .chat-attach {
                    background: #e2e8f0;
                    color: #0f172a;
                    border-radius: 8px;
                    padding: 6px 10px;
                    font-size: 12px;
                    cursor: pointer;
                }
                .chat-file-input {
                    display: none;
                }
                .chat-input input {
                    flex: 1;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 8px;
                    font-size: 13px;
                }
                .chat-attachment-list {
                    display: grid;
                    gap: 6px;
                    margin-top: 6px;
                }
                .chat-attachment-item {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 8px;
                    border-radius: 8px;
                    background: #f1f5f9;
                    font-size: 12px;
                    text-decoration: none;
                    color: #0f172a;
                }
                .chat-attachment-item img {
                    width: 100px;
                    height: 70px;
                    object-fit: cover;
                    border-radius: 6px;
                    border: 1px solid #e2e8f0;
                    background: #fff;
                }
                .chat-input button {
                    background: #0f172a;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 8px 12px;
                    cursor: pointer;
                }
            </style>
        
            <script>
                (function() {
                    const toggleBtn = document.getElementById('supportChatToggle');
                    const closeBtn = document.getElementById('supportChatClose');
                    const panel = document.getElementById('supportChatPanel');
                    const messagesEl = document.getElementById('supportChatMessages');
                    const inputEl = document.getElementById('supportChatInput');
                    const sendBtn = document.getElementById('supportChatSend');
                    const fileInput = document.getElementById('supportChatFiles');
                    const guestBox = document.getElementById('supportChatGuest');
                    const guestName = document.getElementById('supportGuestName');
                    const guestEmail = document.getElementById('supportGuestEmail');
                    let threadId = null;

                    function getCsrfToken() {
                        const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
                        return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
                    }

                    function renderMessages(messages) {
                        messagesEl.innerHTML = '';
                        messages.forEach((msg) => {
                            const bubble = document.createElement('div');
                            bubble.className = 'chat-bubble ' + (msg.sender === 'ADMIN' ? 'admin' : 'user');
                            if (msg.message) {
                                const textEl = document.createElement('div');
                                textEl.textContent = msg.message;
                                bubble.appendChild(textEl);
                            }

                            if (msg.attachments && msg.attachments.length) {
                                const list = document.createElement('div');
                                list.className = 'chat-attachment-list';
                                msg.attachments.forEach((att) => {
                                    const link = document.createElement('a');
                                    link.className = 'chat-attachment-item';
                                    link.href = att.url;
                                    link.target = '_blank';
                                    if (att.is_image) {
                                        const img = document.createElement('img');
                                        img.src = att.url;
                                        img.alt = att.name;
                                        link.appendChild(img);
                                    } else {
                                        link.textContent = att.name;
                                    }
                                    list.appendChild(link);
                                });
                                bubble.appendChild(list);
                            }
                            messagesEl.appendChild(bubble);
                        });
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }

                    function loadThread() {
                        fetch('/chat/thread/')
                            .then(res => res.json())
                            .then((data) => {
                                threadId = data.thread_id;
                                renderMessages(data.messages || []);
                                if (guestBox) {
                                    if (!userAuthenticated && data.requires_profile) {
                                        guestBox.classList.remove('chat-hidden');
                                    } else {
                                        guestBox.classList.add('chat-hidden');
                                    }
                                }
                                if (guestName && data.guest_name) guestName.value = data.guest_name;
                                if (guestEmail && data.guest_email) guestEmail.value = data.guest_email;
                            });
                    }

                    function sendMessage(text) {
                        const formData = new FormData();
                        formData.append('message', text || '');
                        if (threadId) formData.append('thread_id', threadId);
                        if (!userAuthenticated && guestName && guestEmail) {
                            formData.append('guest_name', guestName.value.trim());
                            formData.append('guest_email', guestEmail.value.trim());
                        }
                        if (fileInput && fileInput.files.length) {
                            Array.from(fileInput.files).forEach((file) => {
                                formData.append('attachments', file);
                            });
                        }

                        fetch('/chat/message/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: formData
                        })
                        .then(res => res.json())
                        .then((data) => {
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            inputEl.value = '';
                            if (fileInput) fileInput.value = '';
                            loadThread();
                        });
                    }

                    toggleBtn.addEventListener('click', () => {
                        panel.classList.toggle('chat-hidden');
                        if (!panel.classList.contains('chat-hidden')) {
                            loadThread();
                        }
                    });

                    closeBtn.addEventListener('click', () => {
                        panel.classList.add('chat-hidden');
                    });

                    sendBtn.addEventListener('click', () => {
                        const text = inputEl.value.trim();
                        if (text || (fileInput && fileInput.files.length)) sendMessage(text);
                    });

                    inputEl.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            const text = inputEl.value.trim();
                            if (text || (fileInput && fileInput.files.length)) sendMessage(text);
                        }
                    });

                    document.querySelectorAll('.chat-quick').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            sendMessage(btn.dataset.text);
                        });
                    });
                })();
            </script>
        
        <style>
            /* Buy Now Button for Product Cards */
            .buy-now-btn-card {
                padding: 12px 20px;
                background: linear-gradient(135deg, #fcbe00 0%, #ffa500 100%);
                color: #111827;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                font-size: 14px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(252, 190, 0, 0.3);
            }
            .buy-now-btn-card:hover {
                background: linear-gradient(135deg, #ffa500 0%, #fcbe00 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(252, 190, 0, 0.4);
                color: #000;
            }
            .buy-now-btn-card:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
        </style>
        
        <script>
            // Buy Now for Product Cards
            function getCsrfToken() {
                const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
                return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
            }

            async function buyNowCard(productId) {
                // Check if user is logged in
                if (!userAuthenticated) {
                    window.location.href = "/login/?next=" + window.location.pathname;
                    return;
                }

                const url = `/buy-now/${productId}/`;
                const csrftoken = getCsrfToken();

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: 'quantity=1'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Redirect to cart
                        window.location.href = data.redirect_url || '/cart/';
                    } else {
                        alert(data.message || 'Failed to process order');
                    }
                } catch (error) {
                    console.error('Buy Now error:', error);
                    alert('An error occurred. Please try again.');
                }
            }

            // Toggle Wishlist for Product Cards
            async function toggleWishlistCard(productId, button) {
                // Check if user is logged in
                if (!userAuthenticated) {
                    window.location.href = "/login/?next=" + window.location.pathname;
                    return;
                }

                const url = `/ajax-add-to-wishlist/${productId}/`;
                const csrftoken = getCsrfToken();
                const icon = button.querySelector('i');
                const isWishlisted = icon.classList.contains('fas');

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Toggle icon
                        if (data.in_wishlist) {
                            icon.classList.remove('fal');
                            icon.classList.add('fas');
                            button.style.color = '#ff4757';
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('fal');
                            button.style.color = '';
                        }
                    } else {
                        alert(data.message || 'Failed to update wishlist');
                    }
                } catch (error) {
                    console.error('Wishlist toggle error:', error);
                    alert('An error occurred. Please try again.');
                }
            }

            // Check wishlist status on page load
            document.addEventListener('DOMContentLoaded', function() {
                if (userAuthenticated) {
                    const wishlistButtons = document.querySelectorAll('.wishlist-btn-card');
                    wishlistButtons.forEach(button => {
                        const productId = button.getAttribute('onclick').match(/\d+/)[0];
                        checkWishlistStatus(productId, button);
                    });
                }
            });

            async function checkWishlistStatus(productId, button) {
                try {
                    const response = await fetch(`/check-wishlist/${productId}/`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.in_wishlist) {
                        const icon = button.querySelector('i');
                        icon.classList.remove('fal');
                        icon.classList.add('fas');
                        button.style.color = '#ff4757';
                    }
                } catch (error) {
                    console.error('Check wishlist error:', error);
                }
            }
        </script>
</body>
</html>
