name: PR Review and Labels

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  pr_labeler:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Label PR by size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const additions = files.reduce((acc, file) => acc + file.additions, 0);
            const deletions = files.reduce((acc, file) => acc + file.deletions, 0);
            const totalChanges = additions + deletions;
            
            let sizeLabel = '';
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 200) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }
            
            // Remove old size labels
            const currentLabels = context.payload.pull_request.labels.map(l => l.name);
            const sizeLabels = currentLabels.filter(l => l.startsWith('size/'));
            
            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: label
              }).catch(() => {});
            }
            
            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [sizeLabel]
            });
      
      - name: Greet first-time contributor
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            
            // Check if this is the user's first PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: creator
            });
            
            if (prs.length === 1) {
              const welcomeMessage = `üéâ Welcome @${creator}!
              
              Thank you for your first contribution to FashionHub! 
              
              We're excited to have you as part of our community. Your PR will be reviewed soon.
              
              Please make sure:
              - ‚úÖ Your code follows our coding standards
              - ‚úÖ All tests pass
              - ‚úÖ You've updated documentation if needed
              
              Thank you for making FashionHub better! üõçÔ∏è`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: welcomeMessage
              });
            }
